<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOLICITUD | CONTACTOS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <div class="container text-center">
        <h2 style="display: inline;">CONTACTOS</h2>
        <h6 style="display: inline; margin-left: 0.5rem;"> (Máximo 3)</h6>
        <hr>
        <form action="http://localhost:3000/guardar-contactos" method="post" autocomplete="off" class="needs-validation"
            novalidate>
            <div id="contactosContainer">

                <div class="row mb-3 align-items-end contactoContainer">
                    <h4>DEL CONTACTO:</h4>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">NOMBRE: *</label>
                            <input type="text" class="form-control" name="NombreContacto1" id="NombreContacto1"
                                maxlength="150" required>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">DIRECCIÓN: *</label>
                            <input type="text" class="form-control" name="DireccionContacto1" id="DireccionContacto1"
                                maxlength="150" required>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">NÚMERO DE CELULAR: *</label>
                            <input type="text" class="form-control" name="CelularContacto1" id="CelularContacto1"
                                required>
                            <small id="avisoCelular1" class="form-text text-danger"></small>
                            <!-- Asegúrate de que el ID sea "avisoCelular1" -->
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">TELÉFONO FIJO: *</label>
                            <input type="text" class="form-control" name="TelefonoContacto1" id="TelefonoContacto1"
                                required>
                            <small id="avisoTelefono1" class="form-text text-danger"></small>
                            <!-- Asegúrate de que el ID sea "avisoTelefono1" -->
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">PUESTO:</label>
                            <input type="text" class="form-control" name="PuestoContacto1" id="PuestoContacto1"
                                maxlength="10">
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">CORREO ELECTRÓNICO PRINCIPAL: *</label>
                            <input type="email" class="form-control" name="EmailContacto1" id="EmailContacto1"
                                required="">
                            <div id="emailError1" class="form-text text-danger"></div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">CORREO ELECTRÓNICO ADICIONAL:</label>
                            <input type="email" class="form-control" name="EmailContactoAdicional1"
                                id="EmailContactoAdicional1">
                            <div id="emailError2" class="form-text text-danger"></div>
                        </div>
                    </div>

                    <div>
                        <div class="mb-3">
                            <label class="form-label">OBSERVACIONES ADICIONALES:</label>
                            <textarea name="ObservacionesContacto1" id="ObservacionesContacto1" rows="5"
                                class="form-control" maxlength="200"></textarea>
                        </div>
                    </div>

                </div>
            </div>

            <button type="button" onclick="agregarContacto()" class="btn btn-primary" id="btnAgregarContacto">+</button>
            <button type="button" onclick="eliminarUltimoContacto()" class="btn btn-danger mr-3"
                id="btnEliminarContacto">-</button>

            <h2>VARIABLES DE RIESGO</h2>
            <hr>
            <div class="row mb-3 align-items-end">
                <div class="col-md-12">
                    <div class="mb-3">
                        <div class="accordion" id="accordionPanelsStayOpenExample">

                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="true"
                                        aria-controls="panelsStayOpen-collapseOne">
                                        MONTO DE LA DEUDA
                                    </button>
                                </h2>
                                <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <table class="table table-hover text-center" id="dataTable">
                                            <thead>
                                                <tr>
                                                    <th scope="col">#</th>
                                                    <th scope="col">CATEGORIAS DE PRODUCTOS Y/O SERVICIOS</th>
                                                    <th scope="col">MONTO ($)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <th scope="row">1</th>
                                                    <td><input type="text" class="form-control text-center"
                                                            placeholder="ADEUDO 1" id="DescripcionAdeudo1"
                                                            name="descripcionAdeudo1">
                                                    </td>
                                                    <td><input type="number" class="form-control text-center montoInput"
                                                            placeholder="MONTO 1" id="adeudoMonto1" name="adeudoMonto1"
                                                            onkeyup="calcularTotal()"></td>
                                                </tr>
                                            </tbody>
                                        </table>

                                        <button type="button" class="btn btn-primary btn-lg" id="agregarBtn"
                                            onclick="agregarFila()">+</button>
                                        <button type="button" class="btn btn-danger btn-lg" id="eliminarBtn"
                                            onclick="eliminarUltimaFila()">-</button>


                                        <div class="mt-3">
                                            <label>Saldo Total Actualizado: $</label>
                                            <span id="total"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false"
                                        aria-controls="panelsStayOpen-collapseTwo">
                                        EDAD DE LA DEUDA SS1
                                    </button>
                                </h2>
                                <div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <a href="EdoCuentaDelCliente.html"
                                            onclick="window.open(this.href,'_blank','width=1000,height=400'); return false;">
                                            LLENAR ESTADO DE CUENTA DEL CLIENTE</a>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#panelsStayOpen-collapseThree" aria-expanded="false"
                                        aria-controls="panelsStayOpen-collapseThree">
                                        HISTORIAL DE PAGOS DEL DEUDOR SS2
                                    </button>
                                </h2>
                                <div id="panelsStayOpen-collapseThree" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <a href="formularioHistorialDePagos.html"
                                            onclick="window.open(this.href,'_blank','width=1000,height=400'); return false;">HISTORIAL
                                            DE PAGOS DEL DEUDOR (LIQUIDEZ)</a>
                                    </div>
                                </div>
                            </div>
                        </div> <br>
                        
                        <div id="error-message" class="alert alert-danger d-none" role="alert">
                            Por favor complete todos los campos marcados en rojo antes de enviar el formulario.
                        </div>
                        <!-- BOTON -->
                        <div class="row mb-3">
                            <div class="col-md-3 offset-md-10 justify-content-end">
                                <button id="Registrar" type="submit" class="btn btn-primary btn-lg">Registrar</button>
                            </div>
                        </div>
        </form>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // Función para validar y limitar la entrada a números y 10 dígitos
        function validarNumerosDiezDigitos(input, avisoId) {
            input.value = input.value.replace(/[^\d]/g, ''); // Remover caracteres no numéricos
            const aviso = document.getElementById(avisoId);
            if (input.value.length !== 10 && input.value.length > 0) {
                aviso.textContent = "El número debe tener 10 dígitos";
            } else {
                aviso.textContent = "";
            }
            if (input.value.length > 10) {
                input.value = input.value.slice(0, 10); // Limitar la longitud a 10 dígitos
            }
        }

        // Agregar listeners para los eventos "input" en los campos
        document.getElementById("CelularContacto1").addEventListener("input", function () {
            validarNumerosDiezDigitos(this, "avisoCelular1");
        });

        document.getElementById("TelefonoContacto1").addEventListener("input", function () {
            validarNumerosDiezDigitos(this, "avisoTelefono1");
        });


        function validateEmail(input, errorId) {
            const email = input.value;
            const emailError = input.parentNode.querySelector('.form-text.text-danger');

            if (!email) {
                input.setCustomValidity('');
                emailError.textContent = '';
            } else if (!isValidEmail(email)) {
                input.setCustomValidity('Correo electrónico no válido');
                emailError.textContent = 'Por favor, introduzca un correo electrónico válido.';
            } else {
                input.setCustomValidity('');
                emailError.textContent = '';
            }
        }

        function isValidEmail(email) {
            // Expresión regular para validar correo electrónico
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailPattern.test(email);
        }

        // Agregar la validación a los campos originales de correo electrónico
        document.getElementById('EmailContacto1').addEventListener('input', function () {
            validateEmail(this, 'emailError1');
        });
        document.getElementById('EmailContactoAdicional1').addEventListener('input', function () {
            validateEmail(this, 'emailError2');
        });


        var contadorContactos = 1; // Contador para identificar los contactos

        // Función para validar y limitar la entrada a números y 10 dígitos en contactos duplicados
        function validarNumerosDiezDigitosDuplicados(input, avisoId) {
            input.value = input.value.replace(/[^\d]/g, ''); // Remover caracteres no numéricos
            const aviso = document.getElementById(avisoId);
            if (input.value.length < 10 && input.value.length > 0) { // Cambio aquí
                aviso.textContent = "El número debe tener 10 dígitos";
            } else {
                aviso.textContent = "";
            }
            if (input.value.length > 10) {
                input.value = input.value.slice(0, 10); // Limitar la longitud a 10 dígitos
            }
        }


        // Función para agregar un nuevo contacto
        function agregarContacto() {
            // Verifica si se ha alcanzado el límite de contactos
            if (contadorContactos < 3) {
                // Clona el primer elemento con la clase "contactoContainer"
                var nuevoContacto = document.querySelector(".contactoContainer").cloneNode(true);

                // Incrementa el contador de contactos
                contadorContactos++;

                // Actualiza el texto del título del nuevo contacto
                nuevoContacto.querySelector("h4").textContent = "DEL CONTACTO ADICIONAL " + contadorContactos + ":";

                // Recorre los elementos de entrada y textarea en el nuevo contacto y actualiza sus IDs y Names
                nuevoContacto.querySelectorAll('input[type="text"], input[type="email"], textarea').forEach(function (input) {
                    var fieldName = input.getAttribute("name");
                    var fieldID = input.getAttribute("id");

                    // Extrae el número de contacto del ID actual
                    var currentContactNumber = fieldID.match(/\d+/);

                    // Reemplaza el número de contacto anterior por el nuevo
                    var newFieldID = fieldID.replace(currentContactNumber, contadorContactos);
                    var newFieldName = fieldName.replace(currentContactNumber, contadorContactos);

                    // Actualiza el ID y el Name del campo
                    input.setAttribute("id", newFieldID);
                    input.setAttribute("name", newFieldName);
                    input.value = ""; // Limpia el valor
                    input.classList.remove("is-invalid");

                    // Elimina la validación del campo
                    input.removeAttribute("oninput");

                    // Asocia la validación al campo de correo electrónico clonado
                    if (input.type === 'email') {
                        input.setAttribute("oninput", "validateEmail(this, 'emailError" + contadorContactos + "')");
                    }

                    // Agrega un listener de evento "input" para la validación de números en el campo de número de teléfono celular
                    if (input.id.startsWith("CelularContacto")) {
                        input.addEventListener("input", function () {
                            validarNumerosDiezDigitosDuplicados(this, "avisoCelular" + contadorContactos);
                        });
                    }

                    // Agrega un listener de evento "input" para la validación de números en el campo de número de teléfono fijo
                    if (input.id.startsWith("TelefonoContacto")) {
                        input.addEventListener("input", function () {
                            validarNumerosDiezDigitosDuplicados(this, "avisoTelefono" + contadorContactos);
                        });
                    }
                });

                // Actualiza los IDs únicos de los elementos small para los avisos
                nuevoContacto.querySelectorAll('small[id^="avisoCelular"]').forEach(function (small) {
                    var currentContactNumber = small.id.match(/\d+/);
                    var newAvisoId = "avisoCelular" + contadorContactos;
                    small.setAttribute("id", newAvisoId);
                    small.textContent = ""; // Limpia el contenido del aviso
                });

                nuevoContacto.querySelectorAll('small[id^="avisoTelefono"]').forEach(function (small) {
                    var currentContactNumber = small.id.match(/\d+/);
                    var newAvisoId = "avisoTelefono" + contadorContactos;
                    small.setAttribute("id", newAvisoId);
                    small.textContent = ""; // Limpia el contenido del aviso
                });

                // Agrega el nuevo contacto al contenedor
                document.getElementById("contactosContainer").appendChild(nuevoContacto);

                // Deshabilita el botón si se alcanza el límite de contactos
                if (contadorContactos === 3) {
                    document.getElementById("btnAgregarContacto").disabled = true;
                }
            }
        }


        function eliminarUltimoContacto() {
            // Verifica si hay más de un contacto para eliminar
            if (contadorContactos > 1) {
                // Obtiene el último contacto creado y lo elimina
                var ultimoContacto = document.querySelector("#contactosContainer .contactoContainer:last-child");
                ultimoContacto.parentNode.removeChild(ultimoContacto);

                // Decrementa el contador de contactos
                contadorContactos--;

                // Habilita el botón de agregar si se deshabilitó previamente
                document.getElementById("btnAgregarContacto").disabled = false;
            }
        }

        var contador = 1;

        function agregarFila() {
            if (contador < 10) {
                contador++;

                var nuevaFila = `
                        <tr>
                            <th scope="row">${contador}</th>
                            <td><input type="text" class="form-control text-center" placeholder="ADEUDO ${contador}" id="descripcionAdeudo${contador}" required></td>
                            <td><input type="number" class="form-control text-center montoInput" placeholder="MONTO ${contador}" id="adeudoMonto${contador}" onkeyup="calcularTotal()" required></td>
                        </tr>
                    `;

                // Agregar la nueva fila al final de la tabla
                $("#dataTable tbody").append(nuevaFila);

                // Calcular y mostrar el total
                calcularTotal();

                // Habilitar el botón de agregar si se deshabilitó previamente
                document.getElementById("agregarBtn").disabled = false;
            } else {
                alert("Solo se permiten hasta 10 filas.");
                document.getElementById("agregarBtn").disabled = true;
            }
        }

        function eliminarUltimaFila() {
            if (contador > 1) {
                // Eliminar la última fila de la tabla
                $("#dataTable tbody tr:last").remove();
                contador--;

                // Calcular y mostrar el total actualizado
                calcularTotal();

                // Habilitar el botón de agregar si se deshabilitó previamente
                document.getElementById("agregarBtn").disabled = false;
            }
        }

        function calcularTotal() {
            var total = 0;

            for (var i = 1; i <= contador; i++) {
                var monto = parseFloat($("#adeudoMonto" + i).val()) || 0;
                total += monto;
            }

            // Asegura que el total se muestre correctamente
            $("#total").text(total.toFixed(2));
        }
    </script>

    <script src="../js/script.js"></script>
</body>

</html>